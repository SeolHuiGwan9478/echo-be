package woozlabs.echo.domain.gemini.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.springframework.stereotype.Service;
import woozlabs.echo.domain.gemini.GeminiInterface;
import woozlabs.echo.domain.gemini.dto.GeminiRequest;
import woozlabs.echo.domain.gemini.dto.GeminiResponse;
import woozlabs.echo.domain.chatGPT.prompt.ScheduleMailPrompt;
import woozlabs.echo.domain.gemini.prompt.ThreadKeypointPrompt;
import woozlabs.echo.domain.gemini.prompt.ThreadSummaryPrompt;
import woozlabs.echo.domain.gemini.prompt.VerificationMailPrompt;
import woozlabs.echo.domain.gmail.dto.thread.*;
import woozlabs.echo.global.exception.CustomErrorException;
import woozlabs.echo.global.exception.ErrorCode;

import java.util.Base64;

@Slf4j
@Service
@RequiredArgsConstructor
public class GeminiService {

    public static final String GEMINI_PRO = "gemini-pro";
    public static final String GEMINI_ULTIMATE = "gemini-ultimate";
    public static final String GEMINI_PRO_VISION = "gemini-pro-vision";

    private final GeminiInterface geminiInterface;

    private GeminiResponse getCompletion(GeminiRequest request) {
        try {
            return geminiInterface.getCompletion(GEMINI_PRO, request);
        } catch (Exception e) {
            log.error("Error while getting completion from Gemini", e);
            throw new CustomErrorException(ErrorCode.FAILED_TO_GEMINI_COMPLETION, e.getMessage());
        }
    }

    public String getCompletion(String text) {
        GeminiRequest geminiRequest = new GeminiRequest(text);
        GeminiResponse response = getCompletion(geminiRequest);

        return response.getCandidates()
                .stream()
                .findFirst().flatMap(candidate -> candidate.getContent().getParts()
                        .stream()
                        .findFirst()
                        .map(GeminiResponse.TextPart::getText))
                .orElse(null);
    }

    public String summarizeGmailThread(GmailThreadGetResponse gmailThread) {
        StringBuilder threadContent = new StringBuilder();
        for (GmailThreadGetMessages message : gmailThread.getMessages()) {
            extractContentFromPayload(message.getPayload(), threadContent);
        }
        String prompt = ThreadSummaryPrompt.getPrompt(threadContent.toString());
        return getCompletion(prompt);
    }

    private void extractContentFromPayload(GmailThreadGetPayload payload, StringBuilder threadContent) {
        String mimeType = payload.getMimeType();
        if ("text/plain".equals(mimeType) || "text/html".equals(mimeType)) {
            processTextPart(payload, threadContent, mimeType);
        } else if (mimeType != null && mimeType.startsWith("multipart/")) {
            if (payload.getParts() != null) {
                for (GmailThreadGetPart part : payload.getParts()) {
                    extractContentFromPart(part, threadContent);
                }
            }
        }
    }

    private void extractContentFromPart(GmailThreadGetPart part, StringBuilder threadContent) {
        if (part == null) return;

        String mimeType = part.getMimeType();
        if ("text/plain".equals(mimeType) || "text/html".equals(mimeType)) {
            processTextPart(part, threadContent, mimeType);
        } else if (mimeType != null && mimeType.startsWith("multipart/")) {
            if (part.getParts() != null) {
                for (GmailThreadGetPart subPart : part.getParts()) {
                    extractContentFromPart(subPart, threadContent);
                }
            }
        }
    }

    private void processTextPart(Object part, StringBuilder threadContent, String mimeType) {
        // part가 Payload인지 Part인지 구분해서 body(본문 데이터) 불러옴
        GmailThreadGetBody body = (part instanceof GmailThreadGetPayload)
                ? ((GmailThreadGetPayload) part).getBody()
                : ((GmailThreadGetPart) part).getBody();

        String bodyData = body.getData();
        if (bodyData != null) {
            String decodedBody = new String(Base64.getUrlDecoder().decode(bodyData));
            if ("text/html".equals(mimeType)) {
                Document doc = Jsoup.parse(decodedBody, "UTF-8");
                decodedBody = doc.text();
            }
            threadContent.append(decodedBody).append("\n\n");
        }
    }

    public String changeTone(String text, String tone) {
        String prompt = "Change the tone of the following text to " + tone + ": " + text;
        return getCompletion(prompt);
    }

    public String checkGrammar(String text) {
        String prompt = "Check and correct the grammar of the following text: " + text;
        return getCompletion(prompt);
    }

    public String summarize(String text) {
        String prompt = ThreadSummaryPrompt.getGmailSummarizeGuidelinesPrompt(text);
        return getCompletion(prompt);
    }

    public String keypoint(String text) {
        String prompt = ThreadKeypointPrompt.getPrompt(text);
        return getCompletion(prompt);
    }

    public String analyzeVerificationEmail(String emailContent) {
        String coreContent = extractCoreContent(emailContent);
        String prompt = VerificationMailPrompt.getPrompt(coreContent);
        return getCompletion(prompt);
    }

    private String extractCoreContent(String htmlContent) {
        Document doc = Jsoup.parse(htmlContent, "UTF-8");

        doc.select("style, script, head, title, meta, img").remove();
        doc.select("table, tbody, tr, td, th, thead, tfoot").unwrap();
        Elements coreElements = doc.select("div, p, h1, h2, h3, a, pre, span, td");

        for (Element coreElement : coreElements) {
            coreElement.removeAttr("style");
            coreElement.removeAttr("class");
            coreElement.removeAttr("id");
            coreElement.removeAttr("align");
            coreElement.removeAttr("width");
            coreElement.removeAttr("height");
            coreElement.removeAttr("valign");
            coreElement.removeAttr("bgcolor");
            coreElement.removeAttr("cellpadding");
            coreElement.removeAttr("cellspacing");
            coreElement.removeAttr("border");
        }

        return coreElements.toString();
    }
}
