package woozlabs.echo.domain.gmail.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import woozlabs.echo.domain.calendar.dto.UnAvailableDatesResponse;
import woozlabs.echo.domain.calendar.service.CalendarService;
import woozlabs.echo.domain.chatGPT.service.ChatGptService;
import woozlabs.echo.domain.gmail.dto.draft.GmailDraftCommonRequest;
import woozlabs.echo.domain.gmail.dto.template.GenScheduleEmailTemplateRequest;
import woozlabs.echo.domain.gmail.dto.template.GenScheduleEmailTemplateResponse;
import woozlabs.echo.global.exception.CustomErrorException;
import woozlabs.echo.global.exception.ErrorCode;

import java.util.List;

@Service
@Slf4j
@RequiredArgsConstructor
public class GenService {
    private final ObjectMapper om;
    private final ChatGptService chatGptService;
    private final CalendarService calendarService;
    private final AsyncGmailService asyncGmailService;

    public void generateScheduleEmailTemplate(String uid, GenScheduleEmailTemplateRequest dto){
        try{
            UnAvailableDatesResponse unAvailableDatesResponse = calendarService.getDatesWithNoEventsInTwoWeeks(uid);
            List<String> unAvailableDates = unAvailableDatesResponse.getUnavailableDates();
            String result = chatGptService.generateScheduleEmailTemplate(dto.getContent(), unAvailableDates);
            GenScheduleEmailTemplateResponse templateResponse = om.readValue(result, GenScheduleEmailTemplateResponse.class); // om 에러 한번씩 발생 해결 필요
            // create draft
            GmailDraftCommonRequest request = new GmailDraftCommonRequest();
            request.setSubject("Template automatically generated by Echo");
            request.setToEmailAddress(dto.getToEmail());
            request.setBodyText(templateResponse.getTemplate());
            asyncGmailService.createDraftForReplyTemplate(uid, request, dto.getThreadId());
        }catch (Exception e) {
            throw new CustomErrorException(ErrorCode.GENERATE_SCHEDULE_EMAIL_TEMPLATE_ERROR, ErrorCode.GENERATE_SCHEDULE_EMAIL_TEMPLATE_ERROR.getMessage());
        }
    }
}
